function SIFT_CLASS(){var a=50,b=4;this.generate_keypoints=function(c,d){var e=c.width,f=c.height;HELPER.timer_init();var g=IMAGE.trim_info(c);e=e-g.left-g.right,f=f-g.top-g.bottom;var h=document.createElement("canvas");h.width=e,h.height=f;var i=h.getContext("2d");i.drawImage(c,-g.left,-g.top,c.width,c.height);var j=i.getImageData(0,0,e,f),k=ImageFilters.GrayScale(j);i.putImageData(k,0,0);for(var l=5,m=[],n=0;n<l;n++){var o=document.createElement("canvas");o.width=e,o.height=f;var p=o.getContext("2d");p.drawImage(h,0,0);var j=p.getImageData(0,0,e,f),k=ImageFilters.GaussianBlur(j,n+.5);p.putImageData(k,0,0),m.push(o)}for(var q=[],r=2*b+1,s=1;s<m.length-1;s++)for(var j=m[s].getContext("2d").getImageData(0,0,e,f).data,t=m[s-1].getContext("2d").getImageData(0,0,e,f).data,u=m[s+1].getContext("2d").getImageData(0,0,e,f).data,v=b;v<f-b;v++)for(var n=b;n<e-b;n++){var w=4*(n+v*e);if(0!=j[w+3]&&(j[w]<j[w-4]||j[w]<j[w+4]||j[w]>j[w-4]||j[w]>j[w+4])){for(var x=4*(n+(v-1)*e),y=4*(n+(v+1)*e),z=0,A=-b;A<=b;A++)for(var B=4*(n+(v-A)*e),C=-b;C<=b;C++)z+=j[B+4*C];if(z/=r*r,j[w]+a<z){var D=Math.min(j[x-4],j[x],j[x+4],j[w-4],j[w+4],j[y-4],j[y],j[y+4]);if(j[w]<=D){var E=Math.min(t[x-4],t[x],t[x+4],t[w-4],t[w+4],t[y-4],t[y],t[y+4]);if(j[w]<=E){var F=Math.min(u[x-4],u[x],u[x+4],u[w-4],u[w+4],u[y-4],u[y],u[y+4]);j[w]<=F&&q.push({x:n+g.left,y:v+g.top,w:Math.round(z-j[w]-a)})}}continue}if(j[w]-a>z){var G=Math.max(j[x-4],j[x],j[x+4],j[w-4],j[w+4],j[y-4],j[y],j[y+4]);if(j[w]>=G){var H=Math.max(t[x-4],t[x],t[x+4],t[w-4],t[w+4],t[y-4],t[y],t[y+4]);if(j[w]>=H){var I=Math.max(u[x-4],u[x],u[x+4],u[w-4],u[w+4],u[y-4],u[y],u[y+4]);j[w]>=I&&q.push({x:n+g.left,y:v+g.top,w:Math.round(j[w]-z-a)})}}}}}for(var n=0;n<q.length;n++)for(var v=0;v<q.length;v++)if(n!=v&&q[n].x==q[v].x&&q[n].y==q[v].y){q.splice(n,1),n--;break}if(d!==!0)return q.sort(function(a,b){return parseFloat(b.w)-parseFloat(a.w)}),{points:q,trim_details:g};var J=HELPER.timer("",!0);console.log("key points: "+q.length+", "+J),LAYER.layer_add();var K=3;canvas_active().fillStyle="#ff0000";for(var n in q){var L=q[n];canvas_active().beginPath(),canvas_active().rect(L.x-Math.floor(K/2)+1,L.y-Math.floor(K/2)+1,K,K),canvas_active().fill()}},this.get_area_average=function(a,b,c,d,e){var f=b.data,g=0,h=0;e/=100;for(var l,m,i=c+Math.round(e*a.x)+Math.round(e*a.w),j=d+Math.round(e*a.y)+Math.round(e*a.h),k=4*b.width,n=d+Math.round(e*a.y);n<j;n++){l=n*k;for(var o=c+Math.round(e*a.x);o<i;o++)m=l+4*o,g+=f[m],h++}return Math.round(g/h)}}var SIFT=new SIFT_CLASS;