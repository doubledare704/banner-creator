var ImageFilters={};ImageFilters.utils={initSampleCanvas:function(){var a=document.createElement("canvas"),b=a.getContext("2d");a.width=0,a.height=0,this.getSampleCanvas=function(){return a},this.getSampleContext=function(){return b},this.createImageData=b.createImageData?function(a,c){return b.createImageData(a,c)}:function(a,b){return new ImageData(a,b)}},getSampleCanvas:function(){return this.initSampleCanvas(),this.getSampleCanvas()},getSampleContext:function(){return this.initSampleCanvas(),this.getSampleContext()},createImageData:function(a,b){return this.initSampleCanvas(),this.createImageData(a,b)},clamp:function(a){return a>255?255:a<0?0:a},buildMap:function(a){for(var d,b=[],c=0;c<256;c+=1)b[c]=(d=a(c))>255?255:d<0?0:0|d;return b},applyMap:function(a,b,c){for(var d=0,e=a.length;d<e;d+=4)b[d]=c[a[d]],b[d+1]=c[a[d+1]],b[d+2]=c[a[d+2]],b[d+3]=a[d+3]},mapRGB:function(a,b,c){this.applyMap(a,b,this.buildMap(c))},getPixelIndex:function(a,b,c,d,e){if(a<0||a>=c||b<0||b>=d)switch(e){case 1:a=a<0?0:a>=c?c-1:a,b=b<0?0:b>=d?d-1:b;break;case 2:a=(a%=c)<0?a+c:a,b=(b%=d)<0?b+d:b;break;default:return null}return b*c+a<<2},getPixel:function(a,b,c,d,e,f){if(b<0||b>=d||c<0||c>=e)switch(f){case 1:b=b<0?0:b>=d?d-1:b,c=c<0?0:c>=e?e-1:c;break;case 2:b=(b%=d)<0?b+d:b,c=(c%=e)<0?c+e:c;break;default:return 0}var g=c*d+b<<2;return a[g+3]<<24|a[g]<<16|a[g+1]<<8|a[g+2]},getPixelByIndex:function(a,b){return a[b+3]<<24|a[b]<<16|a[b+1]<<8|a[b+2]},copyBilinear:function(a,b,c,d,e,f,g,h){var m,r,s,t,u,v,w,i=b<0?b-1|0:0|b,j=c<0?c-1|0:0|c,k=b-i,l=c-j,n=0,o=0,p=0,q=0;if(i>=0&&i<d-1&&j>=0&&j<e-1){if(m=j*d+i<<2,!k&&!l)return f[g]=a[m],f[g+1]=a[m+1],f[g+2]=a[m+2],void(f[g+3]=a[m+3]);n=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2],m+=4,o=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2],m=m-8+(d<<2),p=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2],m+=4,q=a[m+3]<<24|a[m]<<16|a[m+1]<<8|a[m+2]}else{if(n=this.getPixel(a,i,j,d,e,h),!k&&!l)return f[g]=n>>16&255,f[g+1]=n>>8&255,f[g+2]=255&n,void(f[g+3]=n>>24&255);o=this.getPixel(a,i+1,j,d,e,h),p=this.getPixel(a,i,j+1,d,e,h),q=this.getPixel(a,i+1,j+1,d,e,h)}r=1-k,s=1-l,t=((n>>16&255)*r+(o>>16&255)*k)*s+((p>>16&255)*r+(q>>16&255)*k)*l,u=((n>>8&255)*r+(o>>8&255)*k)*s+((p>>8&255)*r+(q>>8&255)*k)*l,v=((255&n)*r+(255&o)*k)*s+((255&p)*r+(255&q)*k)*l,w=((n>>24&255)*r+(o>>24&255)*k)*s+((p>>24&255)*r+(q>>24&255)*k)*l,f[g]=t>255?255:t<0?0:0|t,f[g+1]=u>255?255:u<0?0:0|u,f[g+2]=v>255?255:v<0?0:0|v,f[g+3]=w>255?255:w<0?0:0|w},rgbToHsl:function(a,b,c){a/=255,b/=255,c/=255;var d=a>b?a>c?a:c:b>c?b:c,e=a<b?a<c?a:c:b<c?b:c,f=d-e,g=0,h=0,i=(e+d)/2;return 0!==f&&(g=a===d?(b-c)/f+(b<c?6:0):b===d?(c-a)/f+2:(a-b)/f+4,g/=6,h=i>.5?f/(2-d-e):f/(d+e)),[g,h,i]},hslToRgb:function(a,b,c){var d,e,f,g,h,i,j=[];if(0===b)g=h=i=255*c+.5|0,j=[g,h,i];else{e=c<=.5?c*(b+1):c+b-c*b,d=2*c-e,f=a+1/3;for(var k,l=0;l<3;l+=1)f<0?f+=1:f>1&&(f-=1),k=6*f<1?d+(e-d)*f*6:2*f<1?e:3*f<2?d+(e-d)*(2/3-f)*6:d,j[l]=255*k+.5|0,f-=1/3}return j}},ImageFilters.Translate=function(a,b,c,d){},ImageFilters.Scale=function(a,b,c,d){},ImageFilters.Rotate=function(a,b,c,d,e,f){},ImageFilters.Affine=function(a,b,c,d){},ImageFilters.UnsharpMask=function(a,b){},ImageFilters.ConvolutionFilter=function(a,b,c,d,e,f,g,h,i,j){var k=a.data,l=a.width,m=a.height,o=(k.length,this.utils.createImageData(l,m)),p=o.data;e=e||1,f=f||0,g!==!1&&(g=!0),h!==!1&&(h=!0),i=i||0,j=j||0;for(var q=0,r=b>>1,s=c>>1,t=i>>16&255,u=i>>8&255,v=255&i,w=255*j,x=0;x<m;x+=1)for(var y=0;y<l;y+=1,q+=4){for(var F,z=0,A=0,B=0,C=0,D=!1,E=0,G=-r;G<=r;G+=1){var I,H=x+G;0<=H&&H<m?I=H*l:h?I=x*l:D=!0;for(var J=-s;J<=s;J+=1){var K=d[E++];if(0!==K){var L=y+J;if(0<=L&&L<l||(h?L=y:D=!0),D)z+=K*t,A+=K*u,B+=K*v,C+=K*w;else{var M=I+L<<2;z+=K*k[M],A+=K*k[M+1],B+=K*k[M+2],C+=K*k[M+3]}}}}p[q]=(F=z/e+f)>255?255:F<0?0:0|F,p[q+1]=(F=A/e+f)>255?255:F<0?0:0|F,p[q+2]=(F=B/e+f)>255?255:F<0?0:0|F,p[q+3]=g?k[q+3]:(F=C/e+f)>255?255:F<0?0:0|F}return o},ImageFilters.Binarize=function(a,b){var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data;isNaN(b)&&(b=.5),b*=255;for(var i=0;i<f;i+=4){var j=c[i]+c[i+1]+c[i+2]/3;h[i]=h[i+1]=h[i+2]=j<=b?0:255,h[i+3]=255}return g},ImageFilters.BlendAdd=function(a,b,c,d){for(var l,e=a.data,f=a.width,g=a.height,h=e.length,i=this.utils.createImageData(f,g),j=i.data,k=b.data,m=0;m<h;m+=4)j[m]=(l=e[m]+k[m])>255?255:l,j[m+1]=(l=e[m+1]+k[m+1])>255?255:l,j[m+2]=(l=e[m+2]+k[m+2])>255?255:l,j[m+3]=255;return i},ImageFilters.BlendSubtract=function(a,b,c,d){for(var l,e=a.data,f=a.width,g=a.height,h=e.length,i=this.utils.createImageData(f,g),j=i.data,k=b.data,m=0;m<h;m+=4)j[m]=(l=e[m]-k[m])<0?0:l,j[m+1]=(l=e[m+1]-k[m+1])<0?0:l,j[m+2]=(l=e[m+2]-k[m+2])<0?0:l,j[m+3]=255;return i},ImageFilters.BoxBlur=function(){var a=function(a,b,c,d,e){var i,j,k,l,n,o,p,q,r,s,t,u,v,w,f=2*e+1,g=e+1,h=c-1,m=0,x=[];for(r=0,s=256*f;r<s;r+=1)x[r]=r/f|0;for(u=0;u<d;u+=1){for(i=j=k=l=0,n=u,o=m<<2,i+=g*a[o],j+=g*a[o+1],k+=g*a[o+2],l+=g*a[o+3],r=1;r<=e;r+=1)o=m+(r<c?r:h)<<2,i+=a[o],j+=a[o+1],k+=a[o+2],l+=a[o+3];for(t=0;t<c;t+=1)o=n<<2,b[o]=x[i],b[o+1]=x[j],b[o+2]=x[k],b[o+3]=x[l],v=t+g,v>h&&(v=h),w=t-e,w<0&&(w=0),p=m+v<<2,q=m+w<<2,i+=a[p]-a[q],j+=a[p+1]-a[q+1],k+=a[p+2]-a[q+2],l+=a[p+3]-a[q+3],n+=d;m+=c}};return function(b,c,d,e){for(var f=b.data,g=b.width,h=b.height,j=(f.length,this.utils.createImageData(g,h)),k=j.data,l=this.utils.createImageData(g,h),m=l.data,n=0;n<e;n+=1)a(n?k:f,m,g,h,c),a(m,k,h,g,d);return j}}(),ImageFilters.GaussianBlur=function(a,b){var c,d,e;switch(b){case 2:c=5,d=[1,1,2,1,1,1,2,4,2,1,2,4,8,4,2,1,2,4,2,1,1,1,2,1,1],e=52;break;case 3:c=7,d=[1,1,2,2,2,1,1,1,2,2,4,2,2,1,2,2,4,8,4,2,2,2,4,8,16,8,4,2,2,2,4,8,4,2,2,1,2,2,4,2,2,1,1,1,2,2,2,1,1],e=140;break;case 4:c=15,d=[2,2,3,4,5,5,6,6,6,5,5,4,3,2,2,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,6,8,11,13,16,18,19,20,19,18,16,13,11,8,6,6,8,10,13,15,17,19,19,19,17,15,13,10,8,6,5,7,10,12,14,16,17,18,17,16,14,12,10,7,5,5,7,9,11,13,14,15,16,15,14,13,11,9,7,5,4,5,7,9,10,12,13,13,13,12,10,9,7,5,4,3,4,6,7,9,10,10,11,10,10,9,7,6,4,3,2,3,4,5,7,7,8,8,8,7,7,5,4,3,2,2,2,3,4,5,5,6,6,6,5,5,4,3,2,2],e=2044;break;default:c=3,d=[1,2,1,2,4,2,1,2,1],e=16}return this.ConvolutionFilter(a,c,c,d,e,0,!1)},ImageFilters.StackBlur=function(){function c(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var a=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],b=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];return function(d,e){var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,R,S,T,f=d.data,g=d.width,h=d.height,j=(f.length,this.Clone(d)),k=j.data,J=e+e+1,L=g-1,M=h-1,N=e+1,O=N*(N+1)/2,P=new c,Q=P,U=a[e],V=b[e];for(n=1;n<J;n+=1)Q=Q.next=new c,n==N&&(T=Q);for(Q.next=P,r=q=0,m=0;m<h;m+=1){for(A=B=C=D=s=t=u=v=0,w=N*(E=k[q]),x=N*(F=k[q+1]),y=N*(G=k[q+2]),z=N*(H=k[q+3]),s+=O*E,t+=O*F,u+=O*G,v+=O*H,Q=P,n=0;n<N;n+=1)Q.r=E,Q.g=F,Q.b=G,Q.a=H,Q=Q.next;for(n=1;n<N;n+=1)o=q+((L<n?L:n)<<2),s+=(Q.r=E=k[o])*(I=N-n),t+=(Q.g=F=k[o+1])*I,u+=(Q.b=G=k[o+2])*I,v+=(Q.a=H=k[o+3])*I,A+=E,B+=F,C+=G,D+=H,Q=Q.next;for(R=P,S=T,l=0;l<g;l+=1)k[q]=s*U>>V,k[q+1]=t*U>>V,k[q+2]=u*U>>V,k[q+3]=v*U>>V,s-=w,t-=x,u-=y,v-=z,w-=R.r,x-=R.g,y-=R.b,z-=R.a,o=r+((o=l+e+1)<L?o:L)<<2,A+=R.r=k[o],B+=R.g=k[o+1],C+=R.b=k[o+2],D+=R.a=k[o+3],s+=A,t+=B,u+=C,v+=D,R=R.next,w+=E=S.r,x+=F=S.g,y+=G=S.b,z+=H=S.a,A-=E,B-=F,C-=G,D-=H,S=S.next,q+=4;r+=g}for(l=0;l<g;l+=1){for(B=C=D=A=t=u=v=s=0,q=l<<2,w=N*(E=k[q]),x=N*(F=k[q+1]),y=N*(G=k[q+2]),z=N*(H=k[q+3]),s+=O*E,t+=O*F,u+=O*G,v+=O*H,Q=P,n=0;n<N;n+=1)Q.r=E,Q.g=F,Q.b=G,Q.a=H,Q=Q.next;for(p=g,n=1;n<=e;n+=1)q=p+l<<2,s+=(Q.r=E=k[q])*(I=N-n),t+=(Q.g=F=k[q+1])*I,u+=(Q.b=G=k[q+2])*I,v+=(Q.a=H=k[q+3])*I,A+=E,B+=F,C+=G,D+=H,Q=Q.next,n<M&&(p+=g);for(q=l,R=P,S=T,m=0;m<h;m+=1)o=q<<2,k[o]=s*U>>V,k[o+1]=t*U>>V,k[o+2]=u*U>>V,k[o+3]=v*U>>V,s-=w,t-=x,u-=y,v-=z,w-=R.r,x-=R.g,y-=R.b,z-=R.a,o=l+((o=m+N)<M?o:M)*g<<2,s+=A+=R.r=k[o],t+=B+=R.g=k[o+1],u+=C+=R.b=k[o+2],v+=D+=R.a=k[o+3],R=R.next,w+=E=S.r,x+=F=S.g,y+=G=S.b,z+=H=S.a,A-=E,B-=F,C-=G,D-=H,S=S.next,q+=g}return j}}(),ImageFilters.Brightness=function(a,b){var c=a.data,d=a.width,e=a.height,g=(c.length,this.utils.createImageData(d,e)),h=g.data;return this.utils.mapRGB(c,h,function(a){return a+=b,a>255?255:a}),g},ImageFilters.BrightnessContrastGimp=function(a,b,c){var d=a.data,e=a.width,f=a.height,g=d.length,h=this.utils.createImageData(e,f),i=h.data,j=Math.PI/4;b/=100,c*=.99,c/=100,c=Math.tan((c+1)*j);for(var k=0,l=0;l<g;l+=4)k+=19595*d[l]+38470*d[l+1]+7471*d[l+2]>>16;return k/=g/4,this.utils.mapRGB(d,i,function(a){return b<0?a*=1+b:b>0&&(a+=(255-a)*b),0!==c&&(a=(a-k)*c+k),a+.5|0}),h},ImageFilters.BrightnessContrastPhotoshop=function(a,b,c){var d=a.data,e=a.width,f=a.height,h=(d.length,this.utils.createImageData(e,f)),i=h.data;return b=(b+100)/100,c=(c+100)/100,this.utils.mapRGB(d,i,function(a){return a*=b,a=(a-127.5)*c+127.5,a+.5|0}),h},ImageFilters.Channels=function(a,b){var c;switch(b){case 2:c=[0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0];break;case 3:c=[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0];break;default:c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,0]}return this.ColorMatrixFilter(a,c)},ImageFilters.Clone=function(a){return this.Copy(a,this.utils.createImageData(a.width,a.height))},ImageFilters.CloneBuiltin=function(a){var f,b=a.width,c=a.height,d=this.utils.getSampleCanvas(),e=this.utils.getSampleContext();return d.width=b,d.height=c,e.putImageData(a,0,0),f=e.getImageData(0,0,b,c),d.width=0,d.height=0,f},ImageFilters.ColorMatrixFilter=function(a,b){var C,D,E,F,G,H,c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data,i=b[0],j=b[1],k=b[2],l=b[3],m=b[4],n=b[5],o=b[6],p=b[7],q=b[8],r=b[9],s=b[10],t=b[11],u=b[12],v=b[13],w=b[14],x=b[15],y=b[16],z=b[17],A=b[18],B=b[19];for(D=0;D<f;D+=4)E=c[D],F=c[D+1],G=c[D+2],H=c[D+3],h[D]=(C=E*i+F*j+G*k+H*l+m)>255?255:C<0?0:0|C,h[D+1]=(C=E*n+F*o+G*p+H*q+r)>255?255:C<0?0:0|C,h[D+2]=(C=E*s+F*t+G*u+H*v+w)>255?255:C<0?0:0|C,h[D+3]=(C=E*x+F*y+G*z+H*A+B)>255?255:C<0?0:0|C;return g},ImageFilters.ColorTransformFilter=function(a,b,c,d,e,f,g,h,i){var p,q,j=a.data,k=a.width,l=a.height,m=j.length,n=this.utils.createImageData(k,l),o=n.data;for(p=0;p<m;p+=4)o[p]=(q=j[p]*b+f)>255?255:q<0?0:q,o[p+1]=(q=j[p+1]*c+g)>255?255:q<0?0:q,o[p+2]=(q=j[p+2]*d+h)>255?255:q<0?0:q,o[p+3]=(q=j[p+3]*e+i)>255?255:q<0?0:q;return n},ImageFilters.Copy=function(a,b){for(var c=a.data,d=c.length,e=b.data;d--;)e[d]=c[d];return b},ImageFilters.Crop=function(a,b,c,d,e){var r,s,t,u,f=a.data,g=a.width,h=a.height,j=(f.length,this.utils.createImageData(d,e)),k=j.data,l=Math.max(b,0),m=Math.max(c,0),n=Math.min(b+d,g),o=Math.min(c+e,h),p=l-b,q=m-c;for(r=m,dstRow=q;r<o;r+=1,dstRow+=1)for(s=l,dstCol=p;s<n;s+=1,dstCol+=1)t=r*g+s<<2,u=dstRow*d+dstCol<<2,k[u]=f[t],k[u+1]=f[t+1],k[u+2]=f[t+2],k[u+3]=f[t+3];return j},ImageFilters.CropBuiltin=function(a,b,c,d,e){var f=a.width,g=a.height,h=this.utils.getSampleCanvas(),i=this.utils.getSampleContext();h.width=f,h.height=g,i.putImageData(a,0,0);var j=i.getImageData(b,c,d,e);return h.width=0,h.height=0,j},ImageFilters.Desaturate=function(a){for(var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data,h=0;h<e;h+=4){var i=b[h],j=b[h+1],k=b[h+2],l=i>j?i>k?i:k:j>k?j:k,m=i<j?i<k?i:k:j<k?j:k,n=(l+m)/2+.5|0;g[h]=g[h+1]=g[h+2]=n,g[h+3]=b[h+3]}return f},ImageFilters.DisplacementMapFilter=function(a,b,c,d,e,f,g,h,i){var j=a.data,k=a.width,l=a.height,n=(j.length,ImageFilters.Clone(a)),o=n.data;c||(c=0),d||(d=0),e||(e=0),f||(f=0),g||(g=0),h||(h=0),i||(i=2);var u,v,w,x,y,z,A,B,C,p=b.width,q=b.height,r=b.data,s=p+c,t=q+d;for(B=0;B<k;B+=1)for(C=0;C<l;C+=1)u=C*k+B<<2,B<c||C<d||B>=s||C>=t?v=u:(w=(C-d)*p+(B-c)<<2,x=r[w+e],z=B+((x-128)*g>>8),y=r[w+f],A=C+((y-128)*h>>8),v=ImageFilters.utils.getPixelIndex(z+.5|0,A+.5|0,k,l,i),null===v&&(v=u)),o[u]=j[v],o[u+1]=j[v+1],o[u+2]=j[v+2],o[u+3]=j[v+3];return n},ImageFilters.Dither=function(a,b){var c=a.width,d=a.height,e=this.Clone(a),f=e.data;b=b<2?2:b>255?255:b;var g,l,h=[],i=b-1,j=0,k=0;for(l=0;l<b;l+=1)h[l]=255*l/i;g=this.utils.buildMap(function(a){var c=h[j];return k+=b,k>255&&(k-=255,j+=1),c});var m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=c-1,C=d-1,D=7/16,E=3/16,F=5/16,G=1/16;for(n=0;n<d;n+=1)for(m=0;m<c;m+=1)o=n*c+m<<2,p=f[o],q=f[o+1],r=f[o+2],s=g[p],t=g[q],u=g[r],f[o]=s,f[o+1]=t,f[o+2]=u,v=p-s,w=q-t,x=r-u,o+=4,m<B&&(y=f[o]+D*v,z=f[o+1]+D*w,A=f[o+2]+D*x,f[o]=y>255?255:y<0?0:0|y,f[o+1]=z>255?255:z<0?0:0|z,f[o+2]=A>255?255:A<0?0:0|A),o+=c-2<<2,m>0&&n<C&&(y=f[o]+E*v,z=f[o+1]+E*w,A=f[o+2]+E*x,f[o]=y>255?255:y<0?0:0|y,f[o+1]=z>255?255:z<0?0:0|z,f[o+2]=A>255?255:A<0?0:0|A),o+=4,n<C&&(y=f[o]+F*v,z=f[o+1]+F*w,A=f[o+2]+F*x,f[o]=y>255?255:y<0?0:0|y,f[o+1]=z>255?255:z<0?0:0|z,f[o+2]=A>255?255:A<0?0:0|A),o+=4,m<B&&n<C&&(y=f[o]+G*v,z=f[o+1]+G*w,A=f[o+2]+G*x,f[o]=y>255?255:y<0?0:0|y,f[o+1]=z>255?255:z<0?0:0|z,f[o+2]=A>255?255:A<0?0:0|A);return e},ImageFilters.Edge=function(a){return this.ConvolutionFilter(a,3,3,[-1,-1,-1,-1,8,-1,-1,-1,-1])},ImageFilters.Emboss=function(a){return this.ConvolutionFilter(a,3,3,[-2,-1,0,-1,1,1,0,1,2])},ImageFilters.Enrich=function(a){return this.ConvolutionFilter(a,3,3,[0,-2,0,-2,20,-2,0,-2,0],10,-40)},ImageFilters.Flip=function(a,b){var i,j,k,l,c=a.data,d=a.width,e=a.height,g=(c.length,this.utils.createImageData(d,e)),h=g.data;for(j=0;j<e;j+=1)for(i=0;i<d;i+=1)k=j*d+i<<2,l=b?(e-j-1)*d+i<<2:j*d+(d-i-1)<<2,h[l]=c[k],h[l+1]=c[k+1],h[l+2]=c[k+2],h[l+3]=c[k+3];return g},ImageFilters.Gamma=function(a,b){var c=a.data,d=a.width,e=a.height,g=(c.length,this.utils.createImageData(d,e)),h=g.data;return this.utils.mapRGB(c,h,function(a){return a=255*Math.pow(a/255,1/b)+.5,a>255?255:a+.5|0}),g},ImageFilters.GrayScale=function(a){for(var b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data,h=0;h<e;h+=4){var i=19595*b[h]+38470*b[h+1]+7471*b[h+2]>>16;g[h]=g[h+1]=g[h+2]=i,g[h+3]=b[h+3]}return f},ImageFilters.HSLAdjustment=function(a,b,c,d){var e=a.data,f=a.width,g=a.height,h=e.length,i=this.utils.createImageData(f,g),j=i.data;b/=360,c/=100,d/=100;var m,n,o,p,q,r,k=this.utils.rgbToHsl,l=this.utils.hslToRgb;for(r=0;r<h;r+=4){for(p=k(e[r],e[r+1],e[r+2]),m=p[0]+b;m<0;)m+=1;for(;m>1;)m-=1;n=p[1]+p[1]*c,n<0?n=0:n>1&&(n=1),o=p[2],d>0?o+=(1-o)*d:d<0&&(o+=o*d),q=l(m,n,o),j[r]=q[0],j[r+1]=q[1],j[r+2]=q[2],j[r+3]=e[r+3]}return i},ImageFilters.Invert=function(a){var b=a.data,c=a.width,d=a.height,f=(b.length,this.utils.createImageData(c,d)),g=f.data;return this.utils.mapRGB(b,g,function(a){return 255-a}),f},ImageFilters.Mosaic=function(a,b){var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,c=a.data,d=a.width,e=a.height,g=(c.length,this.utils.createImageData(d,e)),h=g.data,i=Math.ceil(d/b),j=Math.ceil(e/b);for(k=0;k<j;k+=1)for(o=k*b,p=o+b,p>e&&(p=e),l=0;l<i;l+=1){for(m=l*b,n=m+b,n>d&&(n=d),v=w=x=y=0,u=(n-m)*(p-o),r=o;r<p;r+=1)for(s=r*d,q=m;q<n;q+=1)t=s+q<<2,v+=c[t],w+=c[t+1],x+=c[t+2],y+=c[t+3];for(v=v/u+.5|0,w=w/u+.5|0,x=x/u+.5|0,y=y/u+.5|0,r=o;r<p;r+=1)for(s=r*d,q=m;q<n;q+=1)t=s+q<<2,h[t]=v,h[t+1]=w,h[t+2]=x,h[t+3]=y}return g},ImageFilters.Oil=function(a,b,c){var q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,d=a.data,e=a.width,f=a.height,h=(d.length,this.utils.createImageData(e,f)),i=h.data,j=0,k=[],l=[],m=[],n=[],o=[],p=[];for(r=0;r<f;r+=1)for(q=0;q<e;q+=1){for(s=0;s<c;s+=1)k[s]=l[s]=m[s]=n[s]=o[s]=p[s]=0;for(t=-b;t<=b;t+=1)if(v=r+t,!(v<0||v>=f))for(x=v*e,u=-b;u<=b;u+=1)w=q+u,w<0||w>=e||(y=x+w<<2,z=d[y],A=d[y+1],B=d[y+2],C=z*c>>8,D=A*c>>8,E=B*c>>8,n[C]+=z,o[D]+=A,p[E]+=B,k[C]+=1,l[D]+=1,m[E]+=1);for(F=G=H=0,s=1;s<c;s+=1)k[s]>k[F]&&(F=s),l[s]>l[G]&&(G=s),m[s]>m[H]&&(H=s);i[j]=n[F]/k[F]|0,i[j+1]=o[G]/l[G]|0,i[j+2]=p[H]/m[H]|0,i[j+3]=d[j+3],j+=4}return h},ImageFilters.OpacityFilter=function(a,b){for(var c=a.data,d=a.width,e=a.height,f=c.length,g=this.utils.createImageData(d,e),h=g.data,i=0;i<f;i+=4)h[i]=c[i],h[i+1]=c[i+1],h[i+2]=c[i+2],h[i+3]=b;return g},ImageFilters.Posterize=function(a,b){var c=a.data,d=a.width,e=a.height,g=(c.length,this.utils.createImageData(d,e)),h=g.data;b=b<2?2:b>255?255:b;var m,i=[],j=b-1,k=0,l=0;for(m=0;m<b;m+=1)i[m]=255*m/j;return this.utils.mapRGB(c,h,function(a){var c=i[k];return l+=b,l>255&&(l-=255,k+=1),c}),g},ImageFilters.Rescale=function(a,b){var c=a.data,d=a.width,e=a.height,g=(c.length,this.utils.createImageData(d,e)),h=g.data;return this.utils.mapRGB(c,h,function(a){return a*=b,a>255?255:a+.5|0}),g},ImageFilters.ResizeNearestNeighbor=function(a,b,c){var m,n,o,p,d=a.data,e=a.width,f=a.height,h=(d.length,this.utils.createImageData(b,c)),i=h.data,j=e/b,k=f/c,l=0;for(o=0;o<c;o+=1)for(p=(o*k|0)*e,n=0;n<b;n+=1)m=p+n*j<<2,i[l]=d[m],i[l+1]=d[m+1],i[l+2]=d[m+2],i[l+3]=d[m+3],l+=4;return h},ImageFilters.Resize=function(a,b,c){var m,n,d=a.data,e=a.width,f=a.height,h=(d.length,this.utils.createImageData(b,c)),i=h.data,j=e/b,k=f/c,l=0;for(n=0;n<c;n+=1)for(m=0;m<b;m+=1)this.utils.copyBilinear(d,m*j,n*k,e,f,i,l,0),l+=4;return h},ImageFilters.ResizeBuiltin=function(a,b,c){var h,d=a.width,e=a.height,f=this.utils.getSampleCanvas(),g=this.utils.getSampleContext();return f.width=Math.max(d,b),f.height=Math.max(e,c),g.save(),g.putImageData(a,0,0),g.scale(b/d,c/e),g.drawImage(f,0,0),h=g.getImageData(0,0,b,c),g.restore(),f.width=0,f.height=0,h},ImageFilters.Sepia=function(a){var h,i,j,k,l,b=a.data,c=a.width,d=a.height,e=b.length,f=this.utils.createImageData(c,d),g=f.data;for(k=0;k<e;k+=4)h=b[k],i=b[k+1],j=b[k+2],g[k]=(l=.393*h+.769*i+.189*j)>255?255:l<0?0:l+.5|0,g[k+1]=(l=.349*h+.686*i+.168*j)>255?255:l<0?0:l+.5|0,g[k+2]=(l=.272*h+.534*i+.131*j)>255?255:l<0?0:l+.5|0,g[k+3]=b[k+3];return f},ImageFilters.Sharpen=function(a,b){return this.ConvolutionFilter(a,3,3,[-b/16,-b/8,-b/16,-b/8,.75*b+1,-b/8,-b/16,-b/8,-b/16])},ImageFilters.Solarize=function(a){var b=a.data,c=a.width,d=a.height,f=(b.length,this.utils.createImageData(c,d)),g=f.data;return this.utils.mapRGB(b,g,function(a){return a>127?2*(a-127.5):2*(127.5-a)}),f},ImageFilters.Transpose=function(a){var h,i,b=a.data,c=a.width,d=a.height,f=(b.length,this.utils.createImageData(d,c)),g=f.data;for(y=0;y<d;y+=1)for(x=0;x<c;x+=1)h=y*c+x<<2,i=x*d+y<<2,g[i]=b[h],g[i+1]=b[h+1],g[i+2]=b[h+2],g[i+3]=b[h+3];return f},ImageFilters.Twril=function(a,b,c,d,e,f,g){var h=a.data,i=a.width,j=a.height,l=(h.length,this.utils.createImageData(i,j)),m=l.data;b=i*b,c=j*c,e*=Math.PI/180;var r,s,t,u,v,w,x,y,z,n=d*d,q=0;for(s=0;s<j;s+=1)for(r=0;r<i;r+=1)t=r-b,u=s-c,v=t*t+u*u,v>n?(m[q]=h[q],m[q+1]=h[q+1],m[q+2]=h[q+2],m[q+3]=h[q+3]):(v=Math.sqrt(v),w=Math.atan2(u,t)+e*(d-v)/d,x=b+v*Math.cos(w),y=c+v*Math.sin(w),g?this.utils.copyBilinear(h,x,y,i,j,m,q,f):(z=(y+.5|0)*i+(x+.5|0)<<2,m[q]=h[z],m[q+1]=h[z+1],m[q+2]=h[z+2],m[q+3]=h[z+3])),q+=4;return l};