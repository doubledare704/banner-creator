function LAYER_CLASS(){this.layer_active=0,this.layers=[];var a=0;this.layer_new=function(){this.add_layer()},this.layer_dublicate=function(){if(EDIT.save_state(),0!=DRAW.select_data){this.copy_to_clipboard(),DRAW.select_data=!1,canvas_front.clearRect(0,0,WIDTH,HEIGHT);var b=LAYER.layer_active;this.paste("menu"),LAYER.layer_active=b,LAYER.layer_renew()}else{a++,tmp_data=document.createElement("canvas"),tmp_data.width=WIDTH,tmp_data.height=HEIGHT,tmp_data.getContext("2d").drawImage(canvas_active(!0),0,0);var c="Layer #"+(a+1);LAYER.create_canvas(c),this.layers.push({name:c,visible:!0}),LAYER.layer_active=this.layers.length-1,canvas_active().drawImage(tmp_data,0,0),LAYER.layer_renew()}},this.layer_show_hide=function(){LAYER.layer_visibility(LAYER.layer_active)},this.layer_crop=function(){if(EDIT.save_state(),0==DRAW.select_data)POP.add({html:"Select area first"}),POP.show("Error","");else{var a=LAYER.canvas_active(),b=a.getImageData(DRAW.select_data.x,DRAW.select_data.y,DRAW.select_data.w,DRAW.select_data.h);a.clearRect(0,0,WIDTH,HEIGHT),a.putImageData(b,0,0),DRAW.select_data=!1,canvas_front.clearRect(0,0,WIDTH,HEIGHT)}},this.layer_delete=function(){EDIT.save_state(),LAYER.layer_remove(LAYER.layer_active)},this.layer_move_up=function(){EDIT.save_state(),LAYER.move_layer("up")},this.layer_move_down=function(){EDIT.save_state(),LAYER.move_layer("down")},this.layer_opacity=function(){LAYER.set_alpha()},this.layer_trim=function(){EDIT.save_state(),IMAGE.trim(this.layers[LAYER.layer_active].name,!0)},this.layer_resize=function(){IMAGE.resize_box()},this.layer_clear=function(){EDIT.save_state(),canvas_active().clearRect(0,0,WIDTH,HEIGHT)},this.layer_differences=function(){return parseInt(LAYER.layer_active)+1>=this.layers.length?(POP.add({html:"This can not be last layer"}),POP.show("Error",""),!1):(POP.add({name:"param1",title:"Sensitivity:",value:"0",range:[0,255]}),void POP.show("Differences",function(a){var b=parseInt(a.param1);LAYER.calc_differences(b)},function(a,b,c,d){var e=parseInt(a.param1);LAYER.calc_differences(e,b,c,d)}))},this.layer_merge_down=function(){var a=["source-over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighter","darker","copy","xor"],b=["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"];return parseInt(LAYER.layer_active)+1>=this.layers.length?(POP.add({html:"This can not be last layer."}),POP.show("Error",""),!1):(POP.add({name:"param1",title:"Composition:",values:a}),POP.add({name:"param2",title:"Blend:",values:b}),POP.add({name:"param3",title:"Mode:",values:["Composite","Blend"]}),void POP.show("Merge",function(a){var b=a.param1,c=a.param2,d=a.param3;EDIT.save_state(),LAYER.layer_active++;var e=document.createElement("canvas");e.width=WIDTH,e.height=HEIGHT,e.getContext("2d").drawImage(LAYER.canvas_active(!0),0,0),LAYER.layer_active--,LAYER.canvas_active().save(),"Composite"==d?LAYER.canvas_active().globalCompositeOperation=b:LAYER.canvas_active().globalCompositeOperation=c,LAYER.canvas_active().drawImage(e,0,0),LAYER.canvas_active().restore(),LAYER.layer_remove(LAYER.layer_active+1),LAYER.layer_renew()},function(a,b,c,d){var e=a.param1,f=a.param2,g=a.param3;LAYER.layer_active++;var h=document.createElement("canvas");h.width=c,h.height=d,h.getContext("2d").drawImage(LAYER.canvas_active(!0),0,0,WIDTH,HEIGHT,0,0,c,d),LAYER.layer_active--,b.save(),"Composite"==g?b.globalCompositeOperation=e:b.globalCompositeOperation=f,b.drawImage(h,0,0),b.restore()}))},this.layer_flatten=function(){if(EDIT.save_state(),1==this.layers.length)return!1;tmp_data=document.createElement("canvas"),tmp_data.width=WIDTH,tmp_data.height=HEIGHT;for(var a=1;a<this.layers.length;a++)LAYER.layer_active=a,tmp_data.getContext("2d").clearRect(0,0,WIDTH,HEIGHT),tmp_data.getContext("2d").drawImage(canvas_active(!0),0,0),LAYER.layer_active=0,canvas_active().drawImage(tmp_data,0,0);for(var a=this.layers.length-1;a>0;a--)LAYER.layer_active=a,LAYER.layer_remove(LAYER.layer_active);LAYER.layer_renew()},this.layer_add=function(b,c,d){if(tmp=new Array,a++,void 0==c)void 0==b&&(b="Layer #"+(a+1)),tmp.name=b,tmp.visible=!0,tmp.opacity=1,0==this.layers.length?tmp.primary=1:LAYER.create_canvas(b),this.layers.push(tmp);else{var e=new Image;"http"==c.substring(0,4)&&(e.crossOrigin="Anonymous");var f=this;e.onload=function(){if((e.width>WIDTH||e.height>HEIGHT)&&(e.width>WIDTH&&(WIDTH=e.width),e.height>HEIGHT&&(HEIGHT=e.height),LAYER.set_canvas_size()),1==f.layers.length&&1==EVENTS.autosize){var c=IMAGE.trim_info(document.getElementById("Background"));c.left==WIDTH&&(WIDTH=e.width,HEIGHT=e.height,LAYER.set_canvas_size(!1))}for(var d in f.layers)f.layers[d].name==b&&(b="Layer #"+(a+1));LAYER.create_canvas(b),f.layers.push({name:b,visible:!0,opacity:1}),LAYER.layer_active=f.layers.length-1,document.getElementById(b).getContext("2d").globalAlpha=1,document.getElementById(b).getContext("2d").drawImage(e,0,0),LAYER.layer_renew(),GUI.zoom()},e.onerror=function(a){POP.add({html:"<b>The image could not be loaded.<br /><br /></b>"}),"http"==c.substring(0,4)&&POP.add({title:"Reason:",value:"Cross-origin resource sharing (CORS) not supported. Try to save image first."}),POP.show("Error",".")},e.src=c}LAYER.layer_active=this.layers.length-1,document.getElementById(this.layers[LAYER.layer_active].name).getContext("2d").globalAlpha=1,this.layer_renew()},this.create_canvas=function(a){var b=document.createElement("canvas");b.setAttribute("id",a),document.getElementById("canvas_more").appendChild(b),b.width=WIDTH,b.height=HEIGHT,b.getContext("2d").mozImageSmoothingEnabled=!1,b.getContext("2d").webkitImageSmoothingEnabled=!1,b.getContext("2d").msImageSmoothingEnabled=!1,b.getContext("2d").imageSmoothingEnabled=!1,b.style.width=Math.round(WIDTH*GUI.ZOOM/100)+"px",b.style.height=Math.round(HEIGHT*GUI.ZOOM/100)+"px"},this.move_layer=function(a){if(this.layers.length<2)return!1;if(1==this.layers[LAYER.layer_active].primary)return!1;LAYER.layer_active=parseInt(LAYER.layer_active);var b=this.layers[LAYER.layer_active],c=document.getElementById(this.layers[LAYER.layer_active].name),d=c.parentNode;if("up"==a){if(void 0==this.layers[LAYER.layer_active-1])return!1;if(1==this.layers[LAYER.layer_active-1].primary)return!1;var e=this.layers[LAYER.layer_active-1];d.insertBefore(c,d.firstChild)}else{if(void 0==this.layers[LAYER.layer_active+1])return!1;var e=this.layers[LAYER.layer_active+1],c=document.getElementById(this.layers[LAYER.layer_active+1].name);d.insertBefore(c,d.firstChild)}var f=e.name;e.name=b.name,b.name=f;var f=e.visible;e.visible=b.visible,b.visible=f;var f=e.opacity;e.opacity=b.opacity,b.opacity=f,LAYER.layer_active=this.layers.length-1;for(var g in this.layers)if(this.layers[g].name==e.name){LAYER.layer_active=g;break}return this.layer_renew(),GUI.zoom(),!0},this.layer_visibility=function(a){1==this.layers[a].visible?(this.layers[a].visible=!1,document.getElementById(this.layers[a].name).style.visibility="hidden",document.getElementById("layer_"+a).src="img/yes-grey.png"):(this.layers[a].visible=!0,document.getElementById(this.layers[a].name).style.visibility="visible",document.getElementById("layer_"+a).src="img/yes.png"),this.layer_renew(),GUI.redraw_preview()},this.layer_remove=function(a){return 1!=this.layers[a].primary&&(element=document.getElementById(this.layers[a].name),element.getContext("2d").clearRect(0,0,WIDTH,HEIGHT),element.parentNode.removeChild(element),this.layers.splice(a,1),LAYER.layer_active>=this.layers.length&&(LAYER.layer_active=this.layers.length-1),this.layer_renew(),void GUI.redraw_preview())},this.layer_move_active=function(a,b){var c=10;1==EVENTS.ctrl_pressed&&(c=50),1==EVENTS.shift_pressed&&(c=1),dx=a*c,dy=b*c;var d=canvas_active().getImageData(0,0,WIDTH,HEIGHT);canvas_active().clearRect(0,0,WIDTH,HEIGHT),canvas_active().putImageData(d,dx,dy)},this.select_layer=function(a){LAYER.layer_active!=a&&(LAYER.layer_active=a,this.layer_renew()),LAYER.shake(a)},this.layer_renew=function(){var a="";for(var b in this.layers){a+=LAYER.layer_active==b?'<div class="layer active">':'<div class="layer">';var c=this.layers[b].name;a+='<span class="layer_title" onclick="LAYER.select_layer(\''+b+"')\">"+c+"</span>",a+=1!=this.layers[b].primary?'<a class="layer_visible" onclick="LAYER.layer_remove(\''+b+'\');return false;" title="delete" href="#"></a>':'<a style="visibility:hidden;" class="layer_visible" href="#"></a>',a+=1==this.layers[b].visible?'<a class="layer_delete" id="layer_'+b+'" onclick="LAYER.layer_visibility(\''+b+'\');return false;" title="hide" href="#"></a>':'<a class="layer_delete layer_unvisible" id="layer_'+b+'" onclick="LAYER.layer_visibility(\''+b+'\');return false;" title="show" href="#"></a>',a+="</div>",document.getElementById("layers").innerHTML=a}},this.shake=function(a,b){var c=3,d=10;void 0==b&&(b=0,canvas_front.drawImage(canvas_active(!0),0,0));var e=c*(b%2);0==e&&(e=-c);var f=document.getElementById("canvas_front");f.style.marginLeft=e+"px",b<d?setTimeout(function(){LAYER.shake(a,b+1)},15):(f.style.marginLeft="0px",canvas_front.clearRect(0,0,WIDTH,HEIGHT))},this.update_info_block=function(){document.getElementById("mouse_info_size").innerHTML=WIDTH+"x"+HEIGHT;var a=0,b=0;void 0!=EVENTS.mouse&&(a=EVENTS.mouse.x,b=EVENTS.mouse.y),document.getElementById("mouse_info_mouse").innerHTML=a+", "+b,0!=DRAW.select_data?(document.getElementById("mouse_info_xy").innerHTML=DRAW.select_data.x+", "+DRAW.select_data.y,document.getElementById("mouse_info_area").innerHTML=DRAW.select_data.w+", "+DRAW.select_data.h,document.getElementById("mouse_info_selected").style.display="block"):(document.getElementById("mouse_info_xy").innerHTML="",document.getElementById("mouse_info_area").innerHTML="",document.getElementById("mouse_info_selected").style.display="none")},this.set_canvas_size=function(a){var b=WIDTH/HEIGHT,c=Math.round(WIDTH),d=Math.round(c/b);this.resize_canvas("canvas_back"),GUI.draw_background(canvas_back,WIDTH,HEIGHT),this.resize_canvas("canvas_front",!1),this.resize_canvas("canvas_grid",!0);for(var e in this.layers)a===!1?this.resize_canvas(this.layers[e].name,!1):this.resize_canvas(this.layers[e].name,!0);GUI.draw_grid(),document.getElementById("resize-w").style.marginLeft=c+"px",document.getElementById("resize-w").style.marginTop=Math.round(d/2)+"px",document.getElementById("resize-h").style.marginLeft=Math.round(c/2)+"px",document.getElementById("resize-h").style.marginTop=d+"px",document.getElementById("resize-wh").style.marginLeft=c+"px",document.getElementById("resize-wh").style.marginTop=d+"px",this.update_info_block(),EVENTS.calc_preview_auto(),GUI.zoom()},this.resize_canvas=function(a,b){var c=WIDTH/HEIGHT,d=Math.round(WIDTH),e=Math.round(d/c),f=document.getElementById(a),g=f.getContext("2d");if(0==b)f.width=d,f.height=e;else{var h=document.createElement("canvas");h.width=WIDTH,h.height=HEIGHT,h.getContext("2d").drawImage(f,0,0),f.width=d,f.height=e,g.drawImage(h,0,0)}},this.set_alpha=function(){var a=this;void 0==this.layers[LAYER.layer_active].opacity&&(this.layers[LAYER.layer_active].opacity=1),POP.add({name:"param1",title:"Alpha:",value:this.layers[LAYER.layer_active].opacity,range:[0,1],step:.01}),POP.show("Opacity",function(b){var c=parseFloat(b.param1);a.layers[LAYER.layer_active].opacity=c,canvas_active().globalAlpha=c;var d=canvas_active().getImageData(0,0,WIDTH,HEIGHT),e=d.data,f=255*c;f<10&&(f=10),canvas_active().clearRect(0,0,WIDTH,HEIGHT);for(var g=0;g<d.height;g++)for(var h=0;h<d.width;h++){var i=g*(4*d.width)+4*h;e[i+3]>0&&(e[i+3]=f)}canvas_active().putImageData(d,0,0),GUI.zoom()})},this.canvas_active=function(a){for(var b in this.layers)if(LAYER.layer_active==b)return void 0==a?document.getElementById(this.layers[b].name).getContext("2d"):document.getElementById(this.layers[b].name)},this.add_layer=function(){EDIT.save_state();var a=!1,b=LAYER.layer_active;0!=DRAW.select_data&&(a=document.createElement("canvas"),a.width=DRAW.select_data.w,a.height=DRAW.select_data.h,a.getContext("2d").drawImage(canvas_active(!0),DRAW.select_data.x,DRAW.select_data.y,DRAW.select_data.w,DRAW.select_data.h,0,0,DRAW.select_data.w,DRAW.select_data.h)),LAYER.layer_add(),0!=DRAW.select_data&&(canvas_active().drawImage(a,0,0),LAYER.layer_renew(),DRAW.select_data=!1,canvas_front.clearRect(0,0,WIDTH,HEIGHT),LAYER.layer_active=b,LAYER.layer_renew())},this.calc_differences=function(a,b,c,d){vlayer_active=parseInt(LAYER.layer_active);var e=canvas_active().getImageData(0,0,WIDTH,HEIGHT),f=e.data,g=document.getElementById(this.layers[vlayer_active+1].name).getContext("2d"),h=g.getImageData(0,0,WIDTH,HEIGHT),i=h.data;if(void 0==b){LAYER.layer_add(),canvas_active().rect(0,0,WIDTH,HEIGHT),canvas_active().fillStyle="#ffffff",canvas_active().fill();var j=canvas_active().getImageData(0,0,WIDTH,HEIGHT)}else{var k=document.createElement("canvas");k.width=WIDTH,k.height=HEIGHT;var j=k.getContext("2d").getImageData(0,0,WIDTH,HEIGHT)}for(var l=j.data,m=0;m<WIDTH;m++)for(var n=0;n<HEIGHT;n++){var o=4*(m+n*WIDTH);(Math.abs(f[o]-i[o])>a||Math.abs(f[o+1]-i[o+1])>a||Math.abs(f[o+2]-i[o+2])>a||Math.abs(f[o+3]-i[o+3])>a)&&(l[o]=255,l[o+1]=0,l[o+2]=0,l[o+3]=255)}void 0==b?canvas_active().putImageData(j,0,0):(k.getContext("2d").rect(0,0,WIDTH,HEIGHT),k.getContext("2d").fillStyle="#ffffff",k.getContext("2d").fill(),k.getContext("2d").putImageData(j,0,0),b.clearRect(0,0,c,d),b.save(),b.scale(c/WIDTH,d/HEIGHT),b.drawImage(k,0,0),b.restore())}}function canvas_active(a){for(var b in LAYER.layers)if(LAYER.layer_active==b)return void 0==a?document.getElementById(LAYER.layers[b].name).getContext("2d"):document.getElementById(LAYER.layers[b].name);console.log("Error, can not find active layer.")}var LAYER=new LAYER_CLASS;