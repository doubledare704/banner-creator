function EVENTS_CLASS(){this.mouse,this.ctrl_pressed=!1,this.command_pressed=!1,this.shift_pressed=!1,this.ZOOM_POS=[0,0],this.mini_rect_data={w:0,h:0},this.isDrag=!1,this.sr_size=8,this.clear_front_on_release=!0;var b=[!1,!1],c=[!1,!1],d=!1,e=!1,f=[0,0],g=[0,0],h=!1;this.on_keyboard_action=function(a){if(k=a.keyCode,27!=k){if(void 0!=POP&&1==POP.active)return!0;if("text"==document.activeElement.type||"number"==document.activeElement.type)return!0}if(1==a.ctrlKey&&(EVENTS.ctrl_pressed=!0),1==a.metaKey&&(EVENTS.command_pressed=!0,EVENTS.ctrl_pressed=!0),38==k){if("select_tool"==DRAW.active_tool)return EDIT.save_state(),LAYER.layer_move_active(0,-1),!1}else if(40==k){if("select_tool"==DRAW.active_tool)return EDIT.save_state(),LAYER.layer_move_active(0,1),!1}else if(39==k){if("select_tool"==DRAW.active_tool)return EDIT.save_state(),LAYER.layer_move_active(1,0),!1}else if(37==k){if("select_tool"==DRAW.active_tool)return EDIT.save_state(),LAYER.layer_move_active(-1,0),!1}else if(27==k)void 0!=POP&&1==POP.active&&POP.hide(),DRAW.last_line=[],DRAW.curve_points=[],0!=DRAW.select_data&&EDIT.edit_clear();else if(90==k)1==EVENTS.ctrl_pressed&&EDIT.undo();else if(84==k)EDIT.save_state(),IMAGE.trim();else if(79==k)FILE.open();else if(83==k)void 0!=POP&&FILE.save_dialog(a);else if(76==k)EDIT.save_state(),IMAGE.rotate_resize_doc(270,WIDTH,HEIGHT),IMAGE.rotate_layer({angle:270},canvas_active(),WIDTH,HEIGHT);else if(82==k)IMAGE.resize_box();else if(71==k)0==GUI.grid?GUI.grid=!0:GUI.grid=!1,GUI.draw_grid();else if(46==k)0!=DRAW.select_data&&(EDIT.save_state(),canvas_active().clearRect(DRAW.select_data.x,DRAW.select_data.y,DRAW.select_data.w,DRAW.select_data.h),DRAW.select_data=!1,DRAW.select_square_action="",canvas_front.clearRect(0,0,WIDTH,HEIGHT));else if(16==k)EVENTS.shift_pressed=!0;else if(68==k)call_menu(LAYER,"layer_dublicate");else if(65==k){if(1==EVENTS.ctrl_pressed)return DRAW.select_data={x:0,y:0,w:WIDTH,h:HEIGHT},GUI.draw_selected_area(),!1}else 86==k?(EDIT.save_state(),1==EVENTS.ctrl_pressed&&EDIT.paste()):70==k?(EDIT.save_state(),IMAGE.auto_adjust(canvas_active(),WIDTH,HEIGHT)):72==k?IMAGE.histogram():109==k?GUI.zoom(-1):107==k?GUI.zoom(1):78==k&&LAYER.add_layer();return GUI.zoom(),!0},this.on_keyboardup_action=function(a){k=a.keyCode,16==k?EVENTS.shift_pressed=!1:0==a.ctrlKey&&1==EVENTS.ctrl_pressed?EVENTS.ctrl_pressed=!1:0==a.metaKey&&1==EVENTS.command_pressed&&(EVENTS.command_pressed=!1,EVENTS.ctrl_pressed=!1)},this.get_mouse_position=function(a){a.changedTouches&&(a=a.changedTouches[0]);var d=!0,f=a.pageX,g=a.pageY,h=document.body.getBoundingClientRect(),i=document.getElementById("canvas_front").getBoundingClientRect(),j=i.left-h.left,k=i.top-h.top,l=a.pageX-j,m=a.pageY-k;if("canvas_front"!=a.target.id&&(d=!1),"canvas_preview"==a.target.id){var n=document.getElementById("canvas_preview").getBoundingClientRect(),o=n.left-h.left,p=n.top-h.top;l=a.pageX-o,m=a.pageY-p}"canvas_preview"!=a.target.id&&100!=GUI.ZOOM&&(l=Math.floor(l/GUI.ZOOM*100),m=Math.floor(m/GUI.ZOOM*100)),EVENTS.mouse={x:l,y:m,click_x:b[0],click_y:b[1],last_x:c[0],last_y:c[1],valid:d,click_valid:e,abs_x:f,abs_y:g}},this.mouse_right_click=function(a){if(void 0!=POP&&1==POP.active)return!0;if(EVENTS.get_mouse_position(a),EVENTS.mouse.x!=EVENTS.mouse.click_x&&EVENTS.mouse.y!=EVENTS.mouse.click_y)return a.preventDefault(),a.stopPropagation(),!1;b[0]=EVENTS.mouse.x,b[1]=EVENTS.mouse.y;for(var c in DRAW)if(c==DRAW.active_tool)return DRAW[c]("right_click",EVENTS.mouse,a)},this.mouse_click=function(a){if(EVENTS.isDrag=!0,void 0!=POP&&1==POP.active)return EVENTS.get_mouse_position(a),f[0]=EVENTS.mouse.abs_x,f[1]=EVENTS.mouse.abs_y,popup=document.getElementById("popup"),g[0]=parseInt(popup.style.top),g[1]=parseInt(popup.style.left),h="popup_drag"==a.target.id,!0;if(EVENTS.get_mouse_position(a),b[0]=EVENTS.mouse.x,b[1]=EVENTS.mouse.y,3==a.which)return!0;e=0!=EVENTS.mouse.valid;for(var c in DRAW)if(c==DRAW.active_tool){DRAW[c]("click",EVENTS.mouse,a);break}"canvas_preview"==a.target.id&&EVENTS.calc_preview_by_mouse(EVENTS.mouse.x,EVENTS.mouse.y),d=!1,100==GUI.ZOOM&&("resize-w"==a.target.id?d="w":"resize-h"==a.target.id?d="h":"resize-wh"==a.target.id&&(d="wh"))},this.mouse_move=function(a){if(void 0!=POP&&1==POP.active)return 1==EVENTS.isDrag&&1==h&&(EVENTS.get_mouse_position(a),popup=document.getElementById("popup"),popup.style.top=g[0]+EVENTS.mouse.abs_y-f[1]+"px",popup.style.left=g[1]+EVENTS.mouse.abs_x-f[0]+"px"),!0;if(EVENTS.get_mouse_position(a),"canvas_preview"==a.target.id&&1==EVENTS.isDrag&&EVENTS.calc_preview_by_mouse(EVENTS.mouse.x,EVENTS.mouse.y),LAYER.update_info_block(),100==GUI.ZOOM&&("resize-w"==a.target.id?document.body.style.cursor="w-resize":"resize-h"==a.target.id?document.body.style.cursor="n-resize":"resize-wh"==a.target.id?document.body.style.cursor="nw-resize":document.body.style.cursor="auto",0!=d&&1==EVENTS.isDrag))return document.body.style.cursor="auto","w"==d?(new_w=EVENTS.mouse.x,new_h=HEIGHT):"h"==d?(new_w=WIDTH,new_h=EVENTS.mouse.y):"wh"==d&&(new_w=EVENTS.mouse.x,new_h=EVENTS.mouse.y),canvas_front.clearRect(0,0,WIDTH,HEIGHT),canvas_front.lineWidth=1,canvas_front.fillStyle="#ff0000",EL.rectangle_dashed(canvas_front,0,0,new_w-1,new_h-1),a.preventDefault(),HELPER.remove_selection(),!1;if(EVENTS.isDrag===!1)for(b in DRAW)if(b==DRAW.active_tool){DRAW[b]("move",EVENTS.mouse,a);break}if(EVENTS.isDrag===!1)return!1;for(var b in DRAW)if(b==DRAW.active_tool){DRAW[b]("drag",EVENTS.mouse,a);break}"select_square"!=DRAW.active_tool&&(DRAW.select_square_action=""),c[0]=EVENTS.mouse.x,c[1]=EVENTS.mouse.y},this.mouse_release=function(a){if(EVENTS.isDrag=!1,void 0!=POP&&1==POP.active)return!0;EVENTS.get_mouse_position(a),c[0]=!1,c[1]=!1,""==DRAW.select_square_action&&1==EVENTS.mouse.valid&&(DRAW.select_data=!1),1==EVENTS.clear_front_on_release&&canvas_front.clearRect(0,0,WIDTH,HEIGHT),GUI.draw_selected_area();for(var b in DRAW)if(b==DRAW.active_tool){DRAW[b]("release",EVENTS.mouse,a);break}0!=d&&100==GUI.ZOOM&&EVENTS.mouse.x>0&&EVENTS.mouse.y>0&&(EDIT.save_state(),EVENTS.autosize=!1,document.body.style.cursor="auto","w"==d?WIDTH=EVENTS.mouse.x:"h"==d?HEIGHT=EVENTS.mouse.y:"wh"==d&&(WIDTH=EVENTS.mouse.x,HEIGHT=EVENTS.mouse.y),LAYER.set_canvas_size(),GUI.zoom()),d=!1,GUI.zoom()},this.upload_drop=function(a){a.preventDefault(),EDIT.save_state();for(var d,b=0,c=0;c<a.dataTransfer.files.length;c++)if(d=a.dataTransfer.files[c],d.type.match("image.*")||d.name.match(".json")){b++;var e=new FileReader;e.file=a.dataTransfer.files[c],1==a.dataTransfer.files.length&&(FILE.SAVE_NAME=d.name.split(".")[d.name.split(".").length-2]),e.onload=function(a){if(this.file.type.match("image.*"))LAYER.layer_add(this.file.name,a.target.result,this.file.type),FILE.save_file_info(this.file);else{var b=FILE.load_json(a.target.result);if(b===!0)return!1}},"text/plain"==d.type?e.readAsText(d):d.name.match(".json")?e.readAsText(d):e.readAsDataURL(d)}},this.mouse_wheel_handler=function(a){var b=100;if(a.preventDefault(),1==EVENTS.ctrl_pressed){var c=Math.max(-1,Math.min(1,a.wheelDelta||-a.detail));return GUI.ZOOM<=100&&c<0&&(b=10),GUI.ZOOM<100&&c>0&&(b=10),c*=b,GUI.ZOOM+c>0&&(GUI.ZOOM=GUI.ZOOM+c,EVENTS.calc_preview_auto(),GUI.zoom()),"zoom"==GUI.action_data().name&&(GUI.action_data().attributes.zoom=GUI.ZOOM,show_action_attributes()),EVENTS.scroll_window(),a.preventDefault(),!1}},this.scroll_window=function(){var a=WIDTH*GUI.ZOOM/100,b=HEIGHT*GUI.ZOOM/100;xx=a*EVENTS.ZOOM_POS[0]/GUI.PREVIEW_SIZE.w,yy=b*EVENTS.ZOOM_POS[1]/GUI.PREVIEW_SIZE.h;var c=document.querySelector("#canvas_wrapper");c.scrollTop=yy,c.scrollLeft=xx},this.calc_preview_by_mouse=function(a,b){return EVENTS.ZOOM_POS[0]=a-EVENTS.mini_rect_data.w/2,EVENTS.ZOOM_POS[1]=b-EVENTS.mini_rect_data.h/2,EVENTS.ZOOM_POS[0]<0&&(EVENTS.ZOOM_POS[0]=0),EVENTS.ZOOM_POS[1]<0&&(EVENTS.ZOOM_POS[1]=0),GUI.zoom(void 0,!0),!0},this.calc_preview_auto=function(){var a=document.querySelector("#canvas_wrapper"),b=a.clientWidth,c=a.clientHeight,d=WIDTH*GUI.ZOOM/100,e=HEIGHT*GUI.ZOOM/100;EVENTS.mini_rect_data.w=Math.round(b*GUI.PREVIEW_SIZE.w/d),EVENTS.mini_rect_data.h=Math.round(c*GUI.PREVIEW_SIZE.h/e),GUI.redraw_preview()},this.on_resize=function(){EVENTS.calc_preview_auto();var a=HELPER.get_dimensions();popup=document.getElementById("popup"),popup.style.top="150px",popup.style.left=Math.round(a[0]/2)+"px",document.querySelector("#sidebar_left").classList.remove("active"),document.querySelector("#sidebar_right").classList.remove("active")}}function call_menu(a,b,c){var d=document.querySelector("#main_menu .selected");void 0!=d&&d.click(),GUI.last_menu=b,a[b](c),GUI.zoom()}function CLIPBOARD_CLASS(a,b){var c=this;if(""!=a)var d=document.getElementById(a),e=document.getElementById(a).getContext("2d");var j,l,f=!1,g=!1;document.addEventListener("keydown",function(a){c.on_keyboard_action(a)},!1),document.addEventListener("keyup",function(a){c.on_keyboardup_action(a)},!1),document.addEventListener("paste",function(a){c.paste_auto(a)},!1),this.init=function(){if(window.Clipboard)return!0;j=document.createElement("div"),j.setAttribute("id","paste_ff"),j.setAttribute("contenteditable",""),j.style.cssText="opacity:0;position:fixed;top:0px;left:0px;",j.style.marginLeft="-20px",j.style.width="10px",document.body.appendChild(j);var a=new MutationObserver(function(a){a.forEach(function(a){return"auto"==l||0==f||"childList"!=a.type||void(1==a.addedNodes.length&&(void 0!=a.addedNodes[0].src&&c.paste_createImage(a.addedNodes[0].src),setTimeout(function(){j.innerHTML=""},20)))})}),b=document.getElementById("paste_ff"),d={attributes:!0,childList:!0,characterData:!0};a.observe(b,d)}(),this.paste_auto=function(a){l="",j.innerHTML="";if(a.clipboardData){var c=a.clipboardData.items;if(c){l="auto";for(var d=0;d<c.length;d++)if(c[d].type.indexOf("image")!==-1){var e=c[d].getAsFile(),f=window.URL||window.webkitURL,g=f.createObjectURL(e);this.paste_createImage(g)}a.preventDefault()}}},this.on_keyboard_action=function(a){if(1==POP.active)return!0;if(k=a.keyCode,(17==k||a.metaKey||a.ctrlKey)&&0==f&&(f=!0),86==k){if(void 0!=document.activeElement&&"text"==document.activeElement.type)return!1;1!=f||window.Clipboard||j.focus()}},this.on_keyboardup_action=function(a){0==a.ctrlKey&&1==f?f=!1:0==a.metaKey&&1==g&&(g=!1,f=!1)},this.paste_createImage=function(c){var f=new Image;f.onload=function(){""!=a&&(1==b?(d.width=f.width,d.height=f.height):e.clearRect(0,0,d.width,d.height)),LAYER.layer_add("Paste",c)},f.src=c}}var EVENTS=new EVENTS_CLASS;document.onkeydown=function(a){return EVENTS.on_keyboard_action(a)},document.onkeyup=function(a){return EVENTS.on_keyboardup_action(a)},window.ondrop=function(a){EVENTS.upload_drop(a)},window.ondragover=function(a){a.preventDefault()},window.onresize=function(a){EVENTS.on_resize()},document.onmousedown=EVENTS.mouse_click,document.onmousemove=EVENTS.mouse_move,document.onmouseup=EVENTS.mouse_release,document.addEventListener("mousewheel",EVENTS.mouse_wheel_handler,!1),document.addEventListener("DOMMouseScroll",EVENTS.mouse_wheel_handler,!1),document.oncontextmenu=function(a){return EVENTS.mouse_right_click(a)},document.addEventListener("MSPointerDown",EVENTS.mouse_click,!1),document.addEventListener("MSPointerMove",EVENTS.mouse_move,!1),document.addEventListener("MSPointerUp",EVENTS.mouse_release,!1),document.addEventListener("touchstart",EVENTS.mouse_click,!1),document.addEventListener("touchend",EVENTS.mouse_release,!1),document.addEventListener("touchmove",EVENTS.mouse_move,!1);var CLIPBOARD=new CLIPBOARD_CLASS("",!1);